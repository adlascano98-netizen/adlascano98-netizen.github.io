<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Sensors Advance Laboratory</title>
<script src="https://cdn.jsdelivr.net/npm/mqtt/dist/mqtt.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/remixicon/fonts/remixicon.css" rel="stylesheet">
<style>
body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
header { text-align: center; margin-bottom: 20px; background: #e0e0e0; padding: 15px; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.15); }
header h1 { margin: 0; font-size: 28px; display: flex; justify-content: center; align-items: center; gap: 10px; color: #1a3d7c; }
header h1 i { color: #1a3d7c; }
header #fecha { font-size:16px; margin-top:5px; color:#333; }
.tab-container { display: flex; gap:10px; margin-bottom:20px; flex-wrap:wrap; }
.tab { padding:12px 20px; background:#e0e0e0; border-radius:8px; cursor:pointer; font-weight:bold; color:#333; font-size:16px; }
.tab.active { background:#1e88e5; color:white; }
.tab-content { display:none; }
.tab-content.active { display:block; }
.subtab-container { display: flex; gap:8px; margin-bottom:15px; flex-wrap:wrap; background:#f8f8f8; padding:10px; border-radius:8px; }
.subtab { padding:8px 12px; background:#d0d0d0; border-radius:5px; cursor:pointer; font-weight:bold; color:#333; font-size:14px; }
.subtab.active { background:#4caf50; color:white; }
.subtab-content { display:none; }
.subtab-content.active { display:block; }
.sensor-container { display:flex; gap:20px; margin-bottom:30px; flex-wrap:wrap; }
.panel { border:1px solid #ccc; padding:15px; border-radius:10px; flex:1; background:#fff; box-shadow:0 1px 4px rgba(0,0,0,0.1); min-width:250px; }
.panel canvas {width: 600px !important; height: 300px !important; min-width: 600px !important; min-height: 300px !important; max-width: 600px !important; max-height: 300px !important;}
.panel.grafica { width: 600px; height: 300px; min-width: 600px; min-height: 300px; }
.subtitulo { font-size:20px; font-weight:bold; text-decoration:underline; margin:10px 0; color:#1a3d7c; display:flex; align-items:center; gap:5px; }
.valor { font-size:16px; margin:5px 0; }
button { padding:10px; margin:5px 0; border:none; background:#1e88e5; color:white; border-radius:5px; cursor:pointer; width:100%; }
button:hover { background:#1565c0; }
</style>
</head>
<body>
<header>
<h1><i class="ri-windy-line"></i> Sensors Advance Laboratory</h1>
<div id="fecha">Fecha: --</div>
</header>

<div class="tab-container">
  <div class="tab active" data-target="con_agua">üå± Plantas con Agua</div>
  <div class="tab" data-target="sin_agua">üåµ Plantas sin Agua</div>
</div>

<div id="con_agua" class="tab-content active">
  <div class="subtab-container">
    <div class="subtab active" data-target="planta1">Planta 1</div>
    <div class="subtab" data-target="planta2">Planta 2</div>
    <div class="subtab" data-target="planta3">Planta 3</div>
    <div class="subtab" data-target="planta4">Planta 4</div>
    <div class="subtab" data-target="planta5">Planta 5</div>
  </div>
  <div id="planta1" class="subtab-content active"></div>
  <div id="planta2" class="subtab-content"></div>
  <div id="planta3" class="subtab-content"></div>
  <div id="planta4" class="subtab-content"></div>
  <div id="planta5" class="subtab-content"></div>
</div>

<div id="sin_agua" class="tab-content">
  <div class="subtab-container">
    <div class="subtab active" data-target="planta6">Planta 6</div>
    <div class="subtab" data-target="planta7">Planta 7</div>
    <div class="subtab" data-target="planta8">Planta 8</div>
    <div class="subtab" data-target="planta9">Planta 9</div>
    <div class="subtab" data-target="planta10">Planta 10</div>
  </div>
  <div id="planta6" class="subtab-content active"></div>
  <div id="planta7" class="subtab-content"></div>
  <div id="planta8" class="subtab-content"></div>
  <div id="planta9" class="subtab-content"></div>
  <div id="planta10" class="subtab-content"></div>
</div>

<script>
function actualizarFecha(){
  const now = new Date();
  document.getElementById('fecha').textContent = `Fecha: ${now.toLocaleDateString()} ${now.toLocaleTimeString()}`;
}
setInterval(actualizarFecha,1000);
actualizarFecha();

const ESPs = {
  planta1: { 
    clientId: "ESP32_Planta1", 
    categoria: "con_agua",
    sensores: {
      1: {nombre: "Sensor Humedad", topic: "sensor/plantas/1", datos: [], grafica: "grafica_planta1_1", status: "status_planta1_1"},
      2: {nombre: "Sensor Temperatura", topic: "sensor/plantas/2", datos: [], grafica: "grafica_planta1_2", status: "status_planta1_2"}
    }
  },
  planta2: { 
    clientId: "ESP32_Planta2", 
    categoria: "con_agua",
    sensores: {
      1: {nombre: "Sensor Humedad", topic: "sensor/plantas/3", datos: [], grafica: "grafica_planta2_1", status: "status_planta2_1"},
      2: {nombre: "Sensor Temperatura", topic: "sensor/plantas/4", datos: [], grafica: "grafica_planta2_2", status: "status_planta2_2"}
    }
  },
  planta3: { 
    clientId: "ESP32_Planta3", 
    categoria: "con_agua",
    sensores: {
      1: {nombre: "Sensor Humedad", topic: "sensor/plantas/5", datos: [], grafica: "grafica_planta3_1", status: "status_planta3_1"},
      2: {nombre: "Sensor Temperatura", topic: "sensor/plantas/6", datos: [], grafica: "grafica_planta3_2", status: "status_planta3_2"}
    }
  },
  planta4: { 
    clientId: "ESP32_Planta4", 
    categoria: "con_agua",
    sensores: {
      1: {nombre: "Sensor Humedad", topic: "sensor/plantas/7", datos: [], grafica: "grafica_planta4_1", status: "status_planta4_1"},
      2: {nombre: "Sensor Temperatura", topic: "sensor/plantas/8", datos: [], grafica: "grafica_planta4_2", status: "status_planta4_2"}
    }
  },
  planta5: { 
    clientId: "ESP32_Planta5", 
    categoria: "con_agua",
    sensores: {
      1: {nombre: "Sensor Humedad", topic: "sensor/plantas/9", datos: [], grafica: "grafica_planta5_1", status: "status_planta5_1"},
      2: {nombre: "Sensor Temperatura", topic: "sensor/plantas/10", datos: [], grafica: "grafica_planta5_2", status: "status_planta5_2"}
    }
  },
  planta6: { 
    clientId: "ESP32_Planta6", 
    categoria: "sin_agua",
    sensores: {
      1: {nombre: "Sensor Humedad", topic: "sensor/plantas/11", datos: [], grafica: "grafica_planta6_1", status: "status_planta6_1"},
      2: {nombre: "Sensor Temperatura", topic: "sensor/plantas/12", datos: [], grafica: "grafica_planta6_2", status: "status_planta6_2"}
    }
  },
  planta7: { 
    clientId: "ESP32_Planta7", 
    categoria: "sin_agua",
    sensores: {
      1: {nombre: "Sensor Humedad", topic: "sensor/plantas/13", datos: [], grafica: "grafica_planta7_1", status: "status_planta7_1"},
      2: {nombre: "Sensor Temperatura", topic: "sensor/plantas/14", datos: [], grafica: "grafica_planta7_2", status: "status_planta7_2"}
    }
  },
  planta8: { 
    clientId: "ESP32_Planta8", 
    categoria: "sin_agua",
    sensores: {
      1: {nombre: "Sensor Humedad", topic: "sensor/plantas/15", datos: [], grafica: "grafica_planta8_1", status: "status_planta8_1"},
      2: {nombre: "Sensor Temperatura", topic: "sensor/plantas/16", datos: [], grafica: "grafica_planta8_2", status: "status_planta8_2"}
    }
  },
  planta9: { 
    clientId: "ESP32_Planta9", 
    categoria: "sin_agua",
    sensores: {
      1: {nombre: "Sensor Humedad", topic: "sensor/plantas/17", datos: [], grafica: "grafica_planta9_1", status: "status_planta9_1"},
      2: {nombre: "Sensor Temperatura", topic: "sensor/plantas/18", datos: [], grafica: "grafica_planta9_2", status: "status_planta9_2"}
    }
  },
  planta10: { 
    clientId: "ESP32_Planta10", 
    categoria: "sin_agua",
    sensores: {
      1: {nombre: "Sensor Humedad", topic: "sensor/plantas/19", datos: [], grafica: "grafica_planta10_1", status: "status_planta10_1"},
      2: {nombre: "Sensor Temperatura", topic: "sensor/plantas/20", datos: [], grafica: "grafica_planta10_2", status: "status_planta10_2"}
    }
  }
};

// ------------------ GENERAR BLOQUES ------------------
Object.keys(ESPs).forEach(espKey=>{
  const espDiv = document.getElementById(espKey);
  const esp = ESPs[espKey];
  
  espDiv.innerHTML = `<div style="margin-bottom:10px;font-weight:bold;">Cliente MQTT: <span id="status_${espKey}">Conectando...</span></div>`;
  
  Object.keys(esp.sensores).forEach(sId=>{
    const s = esp.sensores[sId];
    espDiv.innerHTML += `
      <div class="subtitulo"><i class="ri-leaf-line"></i>${s.nombre}</div>
      <div class="sensor-container">
        <div class="panel">
          <div class="valor">VD (V): <span id="VD_${espKey}_${sId}">--</span></div>
          <div class="valor">Rx (Œ©): <span id="Rx_${espKey}_${sId}">--</span></div>
          <div class="valor">Tiempo sensado: <span id="Tiempo_${espKey}_${sId}">0h 0m 0s</span></div>
          <button onclick="descargarExcel('${espKey}',${sId})">‚¨á Descargar Excel (datos desde apertura)</button>
          <div>Estado sensor: <span id="${s.status}">Desconectado ‚ùå</span></div>
        </div>
        <div class="panel" style="flex:2; min-width: 600px; min-height: 300px;">
          <canvas id="${s.grafica}"></canvas>
        </div>
      </div>
    `;
  });
});

// ------------------ INICIALIZAR GR√ÅFICAS ------------------
Object.keys(ESPs).forEach(espKey=>{
  const esp = ESPs[espKey];
  Object.keys(esp.sensores).forEach(sId=>{
    const s = esp.sensores[sId];
    const ctx = document.getElementById(s.grafica).getContext('2d');
    s.graficaObj = new Chart(ctx,{
      type:'line',
      data:{ labels:[], datasets:[{ label: s.nombre + ' VD vs Tiempo', data:[], borderColor:'blue', fill:false, tension: 0.1 }] },
      options: { responsive: true,maintainAspectRatio: false,scales: { x: { title: { display: true, text: "Tiempo (s)" },grid: {display: true}}, y: {title: { display: true, text: "VD (V)" },min: 0,max: 1.7,grid: {display: true}} },plugins: {legend: {display: true,position: 'top',}},animation: {duration: 0},elements: {point: {radius: 0}}}});
  });
});

// ------------------ CONEXI√ìN MQTT ------------------
Object.keys(ESPs).forEach(espKey=>{
  const esp = ESPs[espKey];
  esp.client = mqtt.connect("wss://broker.emqx.io:8084/mqtt",{ clientId: esp.clientId, keepalive:60, reconnectPeriod:3000 });

  esp.client.on("connect", ()=>{
    document.getElementById(`status_${espKey}`).textContent="Conectado ‚úÖ";
    Object.values(esp.sensores).forEach(s=>{
      esp.client.subscribe(s.topic, err=>{
        document.getElementById(s.status).textContent = err ? "Error ‚ùå" : "Suscrito ‚úÖ";
      });
    });
  });

  esp.client.on("message",(topic,message)=>{
    try{
      const data = JSON.parse(message.toString());
      Object.keys(esp.sensores).forEach(sId=>{
        const s = esp.sensores[sId];
        if(s.topic===topic){
          s.datos.push([data.tiempo,data.VD,data.Rx]);

          document.getElementById(`VD_${espKey}_${sId}`).textContent=data.VD;
          document.getElementById(`Rx_${espKey}_${sId}`).textContent=data.Rx;

          // Tiempo total sensado en horas, min y seg
          const totalSeg = s.datos.length * 3; // cada dato representa 3s
          const h = Math.floor(totalSeg/3600);
          const m = Math.floor((totalSeg%3600)/60);
          const sRest = totalSeg%60;
          document.getElementById(`Tiempo_${espKey}_${sId}`).textContent=`${h}h ${m}m ${sRest}s`;

          if(!s.ultimoTiempoGrafica) s.ultimoTiempoGrafica=0;
          if(data.tiempo - s.ultimoTiempoGrafica >=3){
            s.graficaObj.data.labels.push(data.tiempo);
            s.graficaObj.data.datasets[0].data.push(data.VD);
            if(s.graficaObj.data.labels.length>50){
              s.graficaObj.data.labels.shift();
              s.graficaObj.data.datasets[0].data.shift();
            }
            s.graficaObj.update();
            s.ultimoTiempoGrafica = data.tiempo;
          }
        }
      });
    }catch(e){ console.error(e); }
  });
});

// ------------------ DESCARGA ------------------
function descargarExcel(espKey,sId){
  const s = ESPs[espKey].sensores[sId];
  let ws = XLSX.utils.aoa_to_sheet([["Tiempo (s)","VD (V)","Rx (Œ©)"],...s.datos]);
  let wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Datos "+s.nombre);
  XLSX.writeFile(wb,`datos_${espKey}_sensor${sId}.xlsx`);
}

// ------------------ PESTA√ëAS ------------------
document.querySelectorAll(".tab").forEach(tab=>{
  tab.addEventListener("click", ()=>{
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    document.querySelectorAll(".tab-content").forEach(c=>c.classList.remove("active"));
    tab.classList.add("active");
    document.getElementById(tab.dataset.target).classList.add("active");
  });
});

// ------------------ SUBPESTA√ëAS ------------------
document.querySelectorAll(".subtab").forEach(subtab=>{
  subtab.addEventListener("click", ()=>{
    const parent = subtab.closest('.tab-content');
    parent.querySelectorAll(".subtab").forEach(t=>t.classList.remove("active"));
    parent.querySelectorAll(".subtab-content").forEach(c=>c.classList.remove("active"));
    subtab.classList.add("active");
    document.getElementById(subtab.dataset.target).classList.add("active");
  });
});
</script>
</body>
</html>
