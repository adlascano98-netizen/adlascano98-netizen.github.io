<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Sensors Advance Laboratory</title>
<script src="https://cdn.jsdelivr.net/npm/mqtt/dist/mqtt.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/remixicon/fonts/remixicon.css" rel="stylesheet">
<style>
body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
header { text-align: center; margin-bottom: 20px; background: #e0e0e0; padding: 15px; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.15); }
header h1 { margin: 0; font-size: 28px; display: flex; justify-content: center; align-items: center; gap: 10px; color: #1a3d7c; }
header h1 i { color: #1a3d7c; }
header #fecha { font-size:16px; margin-top:5px; color:#333; }
.tab-container { display: flex; gap:10px; margin-bottom:20px; flex-wrap:wrap; }
.tab { padding:12px 20px; background:#e0e0e0; border-radius:8px; cursor:pointer; font-weight:bold; color:#333; font-size:16px; }
.tab.active { background:#1e88e5; color:white; }
.tab-content { display:none; }
.tab-content.active { display:block; }
.subtab-container { display: flex; gap:8px; margin-bottom:15px; flex-wrap:wrap; background:#f8f8f8; padding:10px; border-radius:8px; }
.subtab { padding:8px 12px; background:#d0d0d0; border-radius:5px; cursor:pointer; font-weight:bold; color:#333; font-size:14px; }
.subtab.active { background:#4caf50; color:white; }
.subtab-content { display:none; }
.subtab-content.active { display:block; }
.sensor-container { display:flex; gap:20px; margin-bottom:30px; flex-wrap:wrap; }
.panel { border:1px solid #ccc; padding:15px; border-radius:10px; flex:1; background:#fff; box-shadow:0 1px 4px rgba(0,0,0,0.1); min-width:250px; }
.panel canvas {width: 600px !important; height: 300px !important; min-width: 600px !important; min-height: 300px !important; max-width: 600px !important; max-height: 300px !important;}
.panel.grafica { width: 600px; height: 300px; min-width: 600px; min-height: 300px; }
.subtitulo { font-size:20px; font-weight:bold; text-decoration:underline; margin:10px 0; color:#1a3d7c; display:flex; align-items:center; gap:5px; }
.valor { font-size:16px; margin:5px 0; }
button { padding:10px; margin:5px 0; border:none; background:#1e88e5; color:white; border-radius:5px; cursor:pointer; width:100%; }
button:hover { background:#1565c0; }
</style>
</head>
<body>
<header>
<h1><i class="ri-windy-line"></i> Sensors Advance Laboratory</h1>
<div id="fecha">Fecha: --</div>
</header>

<div class="tab-container">
  <div class="tab active" data-target="con_riego">üå± Plantas con Riego</div>
  <div class="tab" data-target="sin_riego">üåµ Plantas sin Riego</div>
</div>

<div id="con_riego" class="tab-content active">
  <div class="subtab-container">
    <div class="subtab active" data-target="plantaControl_con">Planta Control</div>
    <div class="subtab" data-target="planta1">Planta 1</div>
    <div class="subtab" data-target="planta2">Planta 2</div>
    <div class="subtab" data-target="planta3">Planta 3</div>

  </div>
  <div id="plantaControl_con" class="subtab-content active"></div>
  <div id="planta1" class="subtab-content"></div>
  <div id="planta2" class="subtab-content"></div>
  <div id="planta3" class="subtab-content"></div>

</div>

<div id="sin_riego" class="tab-content">
  <div class="subtab-container">
    <div class="subtab active" data-target="plantaControl_sin">Planta Control</div>
    <div class="subtab" data-target="planta5">Planta 4</div>
    <div class="subtab" data-target="planta6">Planta 5</div>
    <div class="subtab" data-target="planta7">Planta 6</div>
  </div>
  <div id="plantaControl_sin" class="subtab-content active"></div>
  <div id="planta5" class="subtab-content"></div>
  <div id="planta6" class="subtab-content"></div>
  <div id="planta7" class="subtab-content"></div>
</div>

<script>
function actualizarFecha(){
  const now = new Date();
  document.getElementById('fecha').textContent = `Fecha: ${now.toLocaleDateString()} ${now.toLocaleTimeString()}`;
}
setInterval(actualizarFecha,1000);
actualizarFecha();

const ESPs = {
  plantaControl_con: { 
    clientId: "ESP32_ControlCon", 
    categoria: "con_riego",
    sensores: {
      1: {nombre: "Membrana 1", topic: "sensor/plantas/1", datos: [], grafica: "grafica_planta_1", status: "status_planta_1"},
      2: {nombre: "Membrana 2", topic: "sensor/plantas/2", datos: [], grafica: "grafica_planta_2", status: "status_planta_2"}
    }
  },
  planta1: { 
    clientId: "ESP32_Planta1", 
    categoria: "con_riego",
    sensores: {
      1: {nombre: "Membrana 1", topic: "sensor/plantas/3", datos: [], grafica: "grafica_planta_3", status: "status_planta_3"},
      2: {nombre: "Membrana 2", topic: "sensor/plantas/4", datos: [], grafica: "grafica_planta_4", status: "status_planta_4"}
    }
  },
  planta2: { 
    clientId: "ESP32_Planta2", 
    categoria: "con_riego",
    sensores: {
      1: {nombre: "Membrana 1", topic: "sensor/plantas/5", datos: [], grafica: "grafica_planta_5", status: "status_planta_5"},
      2: {nombre: "Membrana 2", topic: "sensor/plantas/6", datos: [], grafica: "grafica_planta_6", status: "status_planta_6"}
    }
  },
  planta3: { 
    clientId: "ESP32_Planta3", 
    categoria: "con_riego",
    sensores: {
      1: {nombre: "Membrana 1", topic: "sensor/plantas/7", datos: [], grafica: "grafica_planta_7", status: "status_planta_7"},
      2: {nombre: "Membrana 2", topic: "sensor/plantas/8", datos: [], grafica: "grafica_planta_8", status: "status_planta_8"}
    }
  },
  plantaControl_sin: { 
    clientId: "ESP32_ControlSin", 
    categoria: "sin_riego",
    sensores: {
      1: {nombre: "Membrana 1", topic: "sensor/plantas/9", datos: [], grafica: "grafica_planta_9", status: "status_planta_9"},
      2: {nombre: "Membrana 2", topic: "sensor/plantas/10", datos: [], grafica: "grafica_planta_10", status: "status_planta_10"}
    }
  },
  planta5: { 
    clientId: "ESP32_Planta5", 
    categoria: "sin_riego",
    sensores: {
      1: {nombre: "Membrana 1", topic: "sensor/plantas/11", datos: [], grafica: "grafica_planta_11", status: "status_planta_11"},
      2: {nombre: "Membrana 2", topic: "sensor/plantas/12", datos: [], grafica: "grafica_planta_12", status: "status_planta_12"}
    }
  },
  planta6: { 
    clientId: "ESP32_Planta6", 
    categoria: "sin_riego",
    sensores: {
      1: {nombre: "Membrana 1", topic: "sensor/plantas/13", datos: [], grafica: "grafica_planta_13", status: "status_planta_13"},
      2: {nombre: "Membrana 2", topic: "sensor/plantas/14", datos: [], grafica: "grafica_planta_14", status: "status_planta_14"}
    }
  },
  planta7: { 
    clientId: "ESP32_Planta7", 
    categoria: "sin_riego",
    sensores: {
      1: {nombre: "Membrana 1", topic: "sensor/plantas/15", datos: [], grafica: "grafica_planta_15", status: "status_planta_15"},
      2: {nombre: "Membrana 2", topic: "sensor/plantas/16", datos: [], grafica: "grafica_planta_16", status: "status_planta_16"}
    }
  },
   
};

// ------------------ GENERAR BLOQUES ------------------
Object.keys(ESPs).forEach(espKey=>{
  const espDiv = document.getElementById(espKey);
  const esp = ESPs[espKey];
  
  if (!espDiv) {
    console.error(`Elemento no encontrado: ${espKey}`);
    return;
  }
  
  espDiv.innerHTML = `<div style="margin-bottom:10px;font-weight:bold;">Cliente MQTT: <span id="status_${espKey}">Conectando...</span></div>`;
  
  Object.keys(esp.sensores).forEach(sId=>{
    const s = esp.sensores[sId];
    espDiv.innerHTML += `
      <div class="subtitulo"><i class="ri-leaf-line"></i>${s.nombre}</div>
      <div class="sensor-container">
        <div class="panel">
          <div class="valor">VD (V): <span id="VD_${espKey}_${sId}">--</span></div>
          <div class="valor">Rx (Œ©): <span id="Rx_${espKey}_${sId}">--</span></div>
          <div class="valor">Tiempo sensado: <span id="Tiempo_${espKey}_${sId}">0h 0m 0s</span></div>
          <button onclick="descargarExcel('${espKey}',${sId})">‚¨á Descargar Excel (datos desde apertura)</button>
          <div>Estado sensor: <span id="${s.status}">Desconectado ‚ùå</span></div>
        </div>
        <div class="panel" style="flex:2; min-width: 600px; min-height: 300px;">
          <canvas id="${s.grafica}"></canvas>
        </div>
      </div>
    `;
  });
});

// ------------------ INICIALIZAR GR√ÅFICAS ------------------
Object.keys(ESPs).forEach(espKey=>{
  const esp = ESPs[espKey];
  Object.keys(esp.sensores).forEach(sId=>{
    const s = esp.sensores[sId];
    const ctx = document.getElementById(s.grafica).getContext('2d');
    s.graficaObj = new Chart(ctx,{
      type:'line',
      data:{ labels:[], datasets:[{ label: s.nombre + ' VD vs Tiempo', data:[], borderColor:'blue', fill:false, tension: 0.1 }] },
      options: { responsive: true,maintainAspectRatio: false,scales: { x: { title: { display: true, text: "Tiempo (s)" },grid: {display: true}}, y: {title: { display: true, text: "VD (V)" },grid: {display: true}} },plugins: {legend: {display: true,position: 'top',}},animation: {duration: 0},elements: {point: {radius: 0}}}});
  });
});

// ------------------ CONEXI√ìN MQTT ------------------
document.addEventListener('DOMContentLoaded', function() {
  const sessionSuffix = Math.random().toString(16).slice(2);
  const webClientId = `WEB_${sessionSuffix}`;
  console.log(`MQTT creando cliente web: ${webClientId}`);
  const client = mqtt.connect("wss://broker.emqx.io:8084/mqtt",{ clientId: webClientId, keepalive:60, reconnectPeriod:3000 });

  setTimeout(() => {
    if (!client.connected) {
      console.warn("MQTT: no conectado despu√©s de 10s. Revisa red/firewall o si el broker est√° disponible.");
    }
  }, 10000);

  const topicToSensor = {};
  Object.keys(ESPs).forEach(espKey=>{
    const esp = ESPs[espKey];
    Object.keys(esp.sensores).forEach(sId=>{
      const s = esp.sensores[sId];
      topicToSensor[s.topic] = { espKey, sId, s };
    });
  });

  client.on("reconnect", ()=>{
    console.warn(`MQTT reconnect (web) (${webClientId})`);
  });

  client.on("offline", ()=>{
    console.warn(`MQTT offline (web) (${webClientId})`);
    Object.keys(ESPs).forEach(espKey=>{
      const statusEl = document.getElementById(`status_${espKey}`);
      if (statusEl) statusEl.textContent = "Offline ‚ùå";
    });
  });

  client.on("close", ()=>{
    console.warn(`MQTT close (web) (${webClientId})`);
  });

  client.on("error", (err)=>{
    console.error(`MQTT error (web) (${webClientId})`, err);
    Object.keys(ESPs).forEach(espKey=>{
      const statusEl = document.getElementById(`status_${espKey}`);
      if (statusEl) statusEl.textContent = "Error ‚ùå";
    });
  });

  client.on("connect", ()=>{
    console.log(`MQTT connect (web) (${webClientId})`);
    Object.keys(ESPs).forEach(espKey=>{
      const statusEl = document.getElementById(`status_${espKey}`);
      if (statusEl) statusEl.textContent = "Conectado ‚úÖ";
    });

    Object.keys(topicToSensor).forEach(topic=>{
      const map = topicToSensor[topic];
      const s = map.s;
      client.subscribe(topic, err=>{
        if (err) {
          console.error("MQTT subscribe error", { topic, err });
        }
        document.getElementById(s.status).textContent = err ? "Error ‚ùå" : "Esperando datos ‚è≥";
        s.lastMessageAt = null;
        if (s.offlineTimer) clearTimeout(s.offlineTimer);
      });
    });
  });

  client.on("message",(topic,message)=>{
    try{
      const map = topicToSensor[topic];
      if (!map) return;
      const { espKey, sId, s } = map;
      const data = JSON.parse(message.toString());

      const tiempoNum = Number(data.tiempo);
      s.datos.push([tiempoNum,data.VD,data.Rx]);

      s.lastMessageAt = Date.now();
      document.getElementById(s.status).textContent = "Recibiendo ‚úÖ";
      if (s.offlineTimer) clearTimeout(s.offlineTimer);
      s.offlineTimer = setTimeout(() => {
        document.getElementById(s.status).textContent = "Sin datos ‚ùå";
      }, 150000);

      document.getElementById(`VD_${espKey}_${sId}`).textContent=data.VD;
      document.getElementById(`Rx_${espKey}_${sId}`).textContent=data.Rx;

      // Tiempo total sensado en horas, min y seg
      const totalMin = s.datos.length; // cada dato representa 1 minuto
      const totalSeg = totalMin * 60;
      const h = Math.floor(totalMin/60);
      const m = totalMin%60;
      document.getElementById(`Tiempo_${espKey}_${sId}`).textContent=`${h}h ${m}m 0s`;

      if(s.ultimoTiempoGrafica === undefined || s.ultimoTiempoGrafica === null) s.ultimoTiempoGrafica = -Infinity;
      if(tiempoNum - s.ultimoTiempoGrafica >= 1){
        s.graficaObj.data.labels.push(tiempoNum);
        s.graficaObj.data.datasets[0].data.push(data.VD);
        if(s.graficaObj.data.labels.length>50){
          s.graficaObj.data.labels.shift();
          s.graficaObj.data.datasets[0].data.shift();
        }
        s.graficaObj.update();
        s.ultimoTiempoGrafica = tiempoNum;
      }
    }catch(e){ console.error(e); }
  });
});

// ------------------ DESCARGA ------------------
function descargarExcel(espKey,sId){
  const s = ESPs[espKey].sensores[sId];
  let ws = XLSX.utils.aoa_to_sheet([["Tiempo (s)","VD (V)","Rx (Œ©)"],...s.datos]);
  let wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Datos "+s.nombre);
  XLSX.writeFile(wb,`datos_${espKey}_sensor${sId}.xlsx`);
}

// ------------------ PESTA√ëAS ------------------
function initTabs() {
  console.log("Inicializando pesta√±as...");
  
  // Pesta√±as principales
  document.querySelectorAll(".tab").forEach(tab=>{
    console.log("Configurando pesta√±a:", tab.dataset.target);
    tab.addEventListener("click", (e)=>{
      e.preventDefault();
      console.log("Click en pesta√±a:", tab.dataset.target);
      
      document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
      document.querySelectorAll(".tab-content").forEach(c=>c.classList.remove("active"));
      
      tab.classList.add("active");
      const targetElement = document.getElementById(tab.dataset.target);
      if (targetElement) {
        targetElement.classList.add("active");
        console.log("Pesta√±a activada:", tab.dataset.target);
      } else {
        console.error("Elemento no encontrado:", tab.dataset.target);
      }
    });
  });

  // Subpesta√±as
  document.querySelectorAll(".subtab").forEach(subtab=>{
    console.log("Configurando subpesta√±a:", subtab.dataset.target);
    subtab.addEventListener("click", (e)=>{
      e.preventDefault();
      console.log("Click en subpesta√±a:", subtab.dataset.target);
      
      const parent = subtab.closest('.tab-content');
      if (parent) {
        parent.querySelectorAll(".subtab").forEach(t=>t.classList.remove("active"));
        parent.querySelectorAll(".subtab-content").forEach(c=>c.classList.remove("active"));
        
        subtab.classList.add("active");
        const targetElement = document.getElementById(subtab.dataset.target);
        if (targetElement) {
          targetElement.classList.add("active");
          console.log("Subpesta√±a activada:", subtab.dataset.target);
        } else {
          console.error("Elemento subpesta√±a no encontrado:", subtab.dataset.target);
        }
      }
    });
  });
}

// Inicializar cuando el DOM est√© listo
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initTabs);
} else {
  initTabs();
}
</script>
</body>
</html>
